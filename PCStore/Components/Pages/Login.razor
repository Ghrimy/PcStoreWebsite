@page "/Login"
@using PCStore_Shared.Models.User
@using PCStore_Shared.Models.Validation
@using PCStore.Components.Services
@inject HttpClient Http
@inject JwtAuthStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS


<MudContainer Class="mt-16 px-12">
    <EditForm Model="_model" OnValidSubmit="LoginAsync">
        <DataAnnotationsValidator/>
        <h3>Login</h3>
        <MudGrid>
            <MudItem xs="12" sm="7">
                <MudCard>
                    <MudTextField Label="Username: " HelperText="Username" @bind-Value="_model.Username"></MudTextField>
                </MudCard>
                <MudCard>
                    <MudTextField Label="Email: " HelperText="Email" @bind-Value="_model.Email"></MudTextField>
                </MudCard>
                <MudCard>
                    <MudTextField Label="Password: " HelperText="Password" @bind-Value="_model.Password"></MudTextField>
                </MudCard>
                
                <MudCard>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Login</MudButton>
                </MudCard>
                <MudCard>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="HandleLogout">Logout</MudButton>
                </MudCard>
                
                <MudCard>
                    <label>@_message</label>
                </MudCard>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudContainer>

@code {
    private readonly UserLoginDto _model = new();
    private string _message;

    private async Task LoginAsync()
    {
        _message = null;

        try
        {
            var response = await Http.PostAsJsonAsync("api/account/login", _model);
            if (!response.IsSuccessStatusCode)
            {
                _message = "Invalid username or password.";
                return;
            }

            var apiResponse = await response.Content.ReadFromJsonAsync<ApiResponseAccount<LoginResultDto>>();
            if (apiResponse == null || apiResponse.Data == null || string.IsNullOrEmpty(apiResponse.Data.Token))
            {
                _message = "Unexpected response from server.";
                return;
            }

            // Store token and update authentication state
            await AuthStateProvider.MarkUserAsAuthenticated(apiResponse.Data.Token);

            // Navigate to dashboard
            Navigation.NavigateTo("/Dashboard");
        }
        catch (Exception ex)
        {
            _message = $"Error: {ex.Message}";
        }
    }

    private async Task LogoutAsync()
    {
        await AuthStateProvider.MarkUserAsLoggedOut();
        Navigation.NavigateTo("/");
    }

    // Prerender-safe token check
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
                if (!string.IsNullOrEmpty(token))
                {
                    await AuthStateProvider.MarkUserAsAuthenticated(token);
                    StateHasChanged();
                }
            }
            catch
            {
                // Ignore JS errors during prerender
            }
        }
    }

    private async Task HandleLogout()
    {
        await AuthStateProvider.MarkUserAsLoggedOut();
        Navigation.NavigateTo("/login");
    }
}